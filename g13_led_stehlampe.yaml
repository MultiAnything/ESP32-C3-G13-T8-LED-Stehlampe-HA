substitutions:
  name: g13-led-ultraslim-stehlampe
  friendly_name: G13 LED UltraSlim Stehlampe

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  name_add_mac_suffix: false
  project:
    name: esphome.g13-led-stehlampe
    version: '1.0'

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: arduino
    version: recommended
  variant: esp32c3

# Logger
logger:
  level: INFO
  logs:
    switch: DEBUG

# API für Home Assistant
api:
  encryption:
    key: !secret api_encryption_key
  reboot_timeout: 15min

# OTA Update
ota:
  - platform: esphome
    password: !secret ota_password
    safe_mode: true
    port: 3232

# WiFi-Konfiguration mit Improv und Captive Portal
wifi:
  # WiFi wird über Improv oder Captive Portal konfiguriert
  # Alternativ können hier auch statische Credentials gesetzt werden:
  # ssid: !secret wifi_ssid
  # password: !secret wifi_password
  fast_connect: true
  power_save_mode: none
  
  # Fallback Access Point
  ap:
    ssid: "G13-LED-Stehlampe"
    password: !secret ap_password

# Improv Serial - WiFi-Provisionierung über Serial
improv_serial:

# Captive Portal für WiFi-Provisionierung
captive_portal:

# ESP32 Improv über Bluetooth LE
esp32_improv:
  authorizer: none

# Web Server für Status
web_server:
  port: 80
  version: 2
  include_internal: true

# Zeit-Synchronisation mit Home Assistant
time:
  - platform: homeassistant
    id: ha_time
    on_sync:
      - logger.log: "Zeit synchronisiert: %02d:%02d:%02d"
        args: ['time.now().hour', 'time.now().minute', 'time.now().second']

# Status LED (falls vorhanden)
status_led:
  pin:
    number: GPIO8
    inverted: false

# Relais-Schalter auf GPIO 5
switch:
  - platform: gpio
    pin: GPIO5
    name: "G13 LED Relais"
    id: g13_relay
    inverted: false
    restore_mode: RESTORE_DEFAULT_OFF
    interlock: []
  
  - platform: restart
    name: "Neustart"
    entity_category: config
  
  - platform: safe_mode
    name: "Safe Mode"
    entity_category: config

# Sensoren
sensor:
  # Interne ESP32 Temperatur
  - platform: internal_temperature
    name: "ESP32 Temperatur"
    id: esp32_temperature
    update_interval: 30s
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    device_class: temperature
    state_class: measurement
  
  # WiFi Signalstärke
  - platform: wifi_signal
    name: "WiFi Signal"
    id: wifi_signal_raw
    update_interval: 30s
    unit_of_measurement: "dBm"
    accuracy_decimals: 0
    device_class: signal_strength
    state_class: measurement
    filters:
      - filter_out: nan
      - filter_out: inf
    # WiFi Signal Bereich: -100 dBm (schlecht) bis -30 dBm (sehr gut)
  
  # Uptime
  - platform: uptime
    name: "Uptime"
    update_interval: 60s
    entity_category: diagnostic

# Text Sensoren
text_sensor:
  - platform: wifi_info
    ip_address:
      name: "IP Adresse"
    ssid:
      name: "WiFi SSID"
    mac_address:
      name: "MAC Adresse"
    entity_category: diagnostic
  
  - platform: version
    name: "ESPHome Version"
    entity_category: diagnostic
  
  # Template Text Sensor für WiFi Signalqualität
  - platform: template
    name: "WiFi Signalqualität"
    id: wifi_signal_quality
    lambda: |-
      float signal = id(wifi_signal_raw).state;
      if (isnan(signal)) {
        return {"Schlecht"};
      }
      if (signal > -50.0f) {
        return {"Sehr gut"};
      } else if (signal > -70.0f) {
        return {"Gut"};
      } else if (signal > -85.0f) {
        return {"Mittel"};
      } else {
        return {"Schlecht"};
      }
    update_interval: 30s
    entity_category: diagnostic
  
  # Template Text Sensor für WiFi Signal Status (für Farbanzeige)
  - platform: template
    name: "WiFi Signal Status"
    id: wifi_signal_status
    lambda: |-
      float signal = id(wifi_signal_raw).state;
      if (isnan(signal)) {
        return {"rot"};
      }
      if (signal > -50.0f) {
        return {"grün"};
      } else if (signal > -70.0f) {
        return {"orange"};
      } else {
        return {"rot"};
      }
    update_interval: 30s
    entity_category: diagnostic

# Binary Sensoren
binary_sensor:
  - platform: status
    name: "Status"
    entity_category: diagnostic

# Interne Komponenten
interval:
  - interval: 30s
    then:
      - logger.log: "G13 LED Stehlampe läuft"

